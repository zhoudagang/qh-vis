<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="./bootstrap.css">
  <link rel="stylesheet" href="./main.css">
</head>
<body>
  <article class="article">
    <header class="header">
      <div class="scheduleCont">
        <p>本月检定计划完成情况</p>
        <!-- <div class="schedule">
          <div class="fin" id="fin"></div>
          <div class="no" id="no"></div>
        </div> -->
        <div class="progress">
          <div id="progress" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
          </div>
        </div>
        <div>
          <span id="finNum">6000</span>
          <span id="total">/7000</span>
          <span id="finPercent" style="float: right;">85.17%</span>
        </div>
      </div>
      <div class="title">
        <img src="./logo.png" alt="国家电网">
        <p style="font-size: 2vw;color:#fff;padding-left: 1vh;">ABCDDDDDDD</p>
      </div>
      <div class="date" id="date">

      </div>
    </header>
    <main class="main">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>检定任务单号</th>
            <th>任务开始日期</th>
            <th>任务结束日期</th>
            <th>任务类型</th>
            <th>到货批次</th>
            <th>设备规格</th>
            <th>通讯规约</th>
            <th>任务数量</th>
            <th>已检定数量</th>
            <th>合格数量</th>
            <th>不合格数量</th>
            <th>检定人员</th>
            <th>核验人员</th>
          </tr>
        </thead>    
        <tbody id="botTable">
          <tr>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
            <td>1</td>
          </tr>
        </tbody>
      </table>
      <footer>
        <nav style="display: flex;justify-content: center;">
          <ul id="pageNav" class="pageNav">
            <li class="pageItem symbol" id="prev" onclick="prev">&lsaquo;</li>
            <li class="pageItem symbol" id="next" onclick="next">&rsaquo;</li>
            <li class="pageItem symbol" style="margin-right: 0;width: 4vw;">
              <input id="pageIndex" type="number" style="width: 98%;margin-top: .1vh;border: none;" type="text" >
            </li>
            <li class="pageItem symbol" style="margin-left: 0;"> 
              <button onclick="goTargetPage()" style="width: 100%;height: 3vh;border-radius: 0;text-align: center;width: 2vw;padding: 0;" type="button" class="btn btn-primary">GO</button>
            </li>
          </ul>
        </nav>
      </footer>
    </main>
  </article>

  <script>
    let nowPage = 1
    let totalPage = 1
    let flag = 1
    window.onload = function(){
      setInterval(showRealTime,1000)
      setInterval(queryVerTaskPage,1000*60*5)

      queryVerNum()
      queryVerTaskPage()

      document.getElementById('pageNav').addEventListener('click',function(ev){
        let target = ev.target
        if(target.classList.contains('pageItem') && !target.classList.contains('symbol')){
          nowPage = target.innerHTML
          console.log(nowPage)
          queryVerTaskPage()
          checkPage()
        }
        return;
      })

      document.getElementById('prev').addEventListener('click',function(ev){
        if(nowPage == 1) return;
        nowPage = parseInt(nowPage,10) - 1
        queryVerTaskPage()
        document.getElementById('next').classList.remove('disabled')
        if(nowPage == 1){
          document.getElementById('prev').classList.add('disabled')
        }else{
          document.getElementById('prev').classList.remove('disabled')
        }
        checkPage()
      })

      document.getElementById('next').addEventListener('click',function(ev){
        console.log(totalPage)
        if(nowPage == totalPage) return;
        document.getElementById('prev').classList.remove('disabled')
        nowPage = parseInt(nowPage,10)  + 1
        queryVerTaskPage()
        if(nowPage == totalPage){
          document.getElementById('next').classList.add('disabled')
        }else{
          document.getElementById('next').classList.remove('disabled')
        }
        checkPage()
      })
    }

    function queryVerNum(){ 
      let xmlHttp;
      if (window.XMLHttpRequest){
        xmlHttp=new XMLHttpRequest();
      }
      else{
        xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");
      }
      xmlHttp.onreadystatechange=function(){
        if (xmlHttp.readyState == 4){
          if((xmlHttp.status>=200 && xmlHttp.status<300) || xmlHttp.status == 304){ 
            let res = JSON.parse(xmlHttp.responseText) 
            if(res.data){
              let data = res.data
              let total = data.verificationPlanNum
              let fin = data.verificationFinishNum
              let percent = data.percent

              document.getElementById('finNum').innerHTML = fin
              document.getElementById('total').innerHTML = '/' + total
              document.getElementById('finPercent').innerHTML = percent
              document.getElementById('progress').style.width = percent

              let num =  parseInt(percent.replace('%',''),10)
              checkProColor(num)
            }else{
              console.log(err)
            }
            
          }else{ 
          }
          // let res = xmlHttp.responseText;
          // console.log(res)
        }
      }
      xmlHttp.open("GET","http://localhost/queryVerNum",true);
      xmlHttp.send();
    }

    //设置进度条颜色
    function checkProColor(num){
      let progress = document.getElementById('progress')
      progress.className = ''
      if(num > 0 && num <= 25){
        progress.classList.add('progress-bar','progress-bar-striped','active','progress-bar-danger')
      }else if(num > 25 && num <=50){
        progress.classList.add('progress-bar','progress-bar-striped','active','progress-bar-warning')
      }else if(num > 50 && num < 100){
        progress.classList.add('progress-bar','progress-bar-striped','active','progress-bar-info')
      }else{
        progress.classList.add('progress-bar','progress-bar-striped','active','progress-bar-success')
      }
    }

    function showRealTime(){
      let d = new Date();
      let year = d.getFullYear();
      let month = d.getMonth() + 1;
      let date = d.getDate();
      let days = new Array("日","一","二","三","四","五","六");
      let day = d.getDay();
      let hour = (d.getHours() < 10) ? ("0" + d.getHours()) : d.getHours();
      let min = (d.getMinutes() < 10) ? ("0" + d.getMinutes()) : d.getMinutes();
      let sec = (d.getSeconds() < 10) ? ("0" + d.getSeconds()) : d.getSeconds();
      let now = year + "年" + month + "月" + date + "日星期" + days[day] + hour + ":" + min + ":" + sec;
      document.getElementById('date').innerHTML = now;
    }

    function queryVerTaskPage(){
      let xmlHttp;
      if (window.XMLHttpRequest){
        xmlHttp=new XMLHttpRequest();
      }
      else{
        xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");
      }
      xmlHttp.onreadystatechange=function(){
        if (xmlHttp.readyState == 4){
          if((xmlHttp.status>=200 && xmlHttp.status<300) || xmlHttp.status == 304){ 
            let res = JSON.parse(xmlHttp.responseText) 
            let data = res.data
            console.log(res)
            if(data.records.length != 0){
              let html = makeTableCont(data.records)
              if(data.records.length<10){
                html += makeNullCont(data.records.length,10)
              }
              document.getElementById('botTable').innerHTML = html

              totalPage = data.pages
            }else{
              let html = makeNullCont(0,10)
              document.getElementById('botTable').innerHTML = html
            }
            if(flag){
              makePage(totalPage)
            }
            flag = 0
          }else{ 
          }
        }
      }
      xmlHttp.open("GET","http://localhost/queryVerTaskPage?pageNo="+nowPage+'&pageSize=10',true);
      xmlHttp.send();
    }

    function makeTableCont(data){
      let html = ''
      for(let i=0;i<data.length;i++){
        html += '<tr>'
        html += '<td>'+data[i].verificationTaskNumber+'</td>'
        html += '<td>'+data[i].taskStartDate+'</td>'
        html += '<td>'+data[i].taskEndDate+'</td>'
        html += '<td>'+data[i].taskType+'</td>'
        html += '<td>'+data[i].aogBatch+'</td>'
        html += '<td>'+data[i].specification+'</td>'
        html += '<td>'+data[i].modbus+'</td>'
        html += '<td>'+data[i].taskNum+'</td>'
        html += '<td>'+data[i].verifiedQuantity+'</td>'
        html += '<td>'+data[i].qualifiedNum+'</td>'
        html += '<td>'+data[i].disQualifiedNum+'</td>'
        html += '<td>'+data[i].verificationPerson+'</td>'
        html += '<td>'+data[i].checkPerson+'</td>'
        html += '</tr>'
      }
      return html
    }

    function makeNullCont(start,end){
      let html = ''
      for(let i=start;i<end;i++){
        html += '<tr>'
        html += '<td>-</td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '<td></td>'
        html += '</tr>'
      }
      return html
    }

    function goTargetPage(){
      var page = document.getElementById('pageIndex').value
      if(totalPage == 1){
        page = 1
        document.getElementById('next').classList.add('disabled')
        document.getElementById('prev').classList.add('disabled')
      }else if(page>=totalPage){
        page = totalPage
        document.getElementById('next').classList.add('disabled')
        document.getElementById('prev').classList.remove('disabled')
      }else if(page<=1){
        page = 1
        document.getElementById('next').classList.remove('disabled')
        document.getElementById('prev').classList.add('disabled')
      }else{
        document.getElementById('next').classList.remove('disabled')
        document.getElementById('prev').classList.remove('disabled')
      }
      nowPage = page
      checkPage()
      document.getElementById('pageIndex').value = nowPage
      queryVerTaskPage()
    }

    function makePage(page){
      let html = ''
      for(let i=1;i<page+1;i++){
        html += '<li id="my_page'+i+'" class="pageItem">'+i+'</li>'
      }
      document.getElementById('prev').insertAdjacentHTML('afterend',html)
      document.getElementById('my_page1').classList.add('checked')
      document.getElementById('prev').classList.add('disabled')
    }

    function checkPage(){
      for(let i=1;i<totalPage+1;i++){
        document.getElementById('my_page'+i).classList.remove('checked')
      }
      document.getElementById('my_page'+nowPage).classList.add('checked')
    }
  </script>
</body>
</html>